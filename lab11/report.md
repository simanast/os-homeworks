## Лабораторная работа № 11.

1)  vector-deadlock.c,  main-common.c и др.:  

-Выполнить  ./vector-deadlock -n 2 -l 1 -v
которая инициирует 2 потока  (-n 2) и каждый из них осуществляет одно  сложение (-1 1) с опцией (-v).
Объяснить результат. Меняется ли он от вызова к вызову?
 
Функция замыкает мьютексы в определённом порядке, создавая возможность появления дедлока, если один поток может вызвать vector_add(v1, v2), пока другой конкурентно вызовет
vector_add(v2, v1).   
Вывод программы меняется, т.к. порядок выполнения потоков не всегда определён. Deadlock не происходит, т.к.  

- Добавить флаг  -d и изменить количество циклов  -l .
Всегда ли возникает состояние взаимной блокировки потоков (deadlock)?
При большом количестве циклов происходит взаимная блокировка.

- Теперь меняем число потоков -n. Есть ли такое число потоков, при котором блокировка не возникает?
При n = 1 блокировок возникнуть не может.

2.  vector-global-order.c:
- За счет чего программа избегает блокировок?   
    + за счёт того, что блокировки ставятся в определённом относительно адресов векторов порядке. 
- Для чего предусмотрен специальный случай в vector add(), когда исходный и результирующий вектор совпадают?
    + чтобы не вызывать повторную блокировку того же мьютекса.
- Флаги: -t -n 2 -l 100000 -d. Как меняется время в зависимости от числа циклов и числа потоков?
    + n = 2, l = 100000: Time: 0.14 seconds
    + n = 3, l = 100000: Time: 0.20 seconds
    + n = 4, l = 100000: Time: 0.33 seconds
    + n = 2, l = 1000000: Time: 0.94 seconds
    + n = 2, l = 10000000: Time: 8.96 seconds
    При увеличении числа потоков/циклов время выполнения растёт.

- Что происходит, когда включается ключ -p (при сложении различных векторов и одного и того же)?
    + /CLionProjects/lab11/threads-bugs$ ./vector-global-order -t -n 2 -l 100000 -d
    + Time: 0.15 seconds
    + /CLionProjects/lab11/threads-bugs$ ./vector-global-order -t -n 2 -l 100000 -d -p
    + Time: 0.05 seconds
    Благодаря этому флагу каждый поток скалдывает свой набор векторов, поэтому взаимного ожидания нет, из-а чего время выполнения уменьшилось.

3. vector-try-wait.c: 
- Нужен ли первый вызов  pthread mutex trylock()?
    + Эта версия vector_add () использует pthread_mutex_trylock (), чтобы попытаться захватить lock; когда попытка не удалась, код освобождает любые блокировки, которые он может удерживать возвращается наверх и пробует все заново.
- Как меняется число повторных попыток, когда растет число потоков?
    + увлеичивается (как и время выполнения), т.к. большее количество потоков пытаются заблокировать вновь и вновь.   
4.  vector-avoid-hold-and-wait.c: 
- Сравнить с другими подходами.
    + в этом случае чтобы изюежать взаимной блокировки, используется глобавльный мьютекс.   
- Как меняется производительность в зависимости от наличия флага -p?
    + ./vector-avoid-hold-and-wait -t -n 5 -l 100000 -p
    + Time: 0.20 seconds
    + ./vector-avoid-hold-and-wait -t -n 5 -l 100000
    + Time: 0.66 seconds
    
5.  vector-nolock.c:
- Сравнить семантику и производительность с другими вариантами при работе с двумя одинаковыми векторами и в случае, когда каждый поток работает на своем векторе  -p.
    + Эта версия vector_add() даже не использует блокировки
     Она использует atomic fetch-and-add для реализации подпрограммы vector_add (). Этот вариант атомарнен в отношении добавления пары записей.
        
        
        nastya@nastya-Lenovo-ideapad-310-15IKB:~/CLionProjects/lab11/threads-bugs$ ./vector-nolock -t -n 6 -l 100000
        Time: 0.67 seconds
        
        nastya@nastya-Lenovo-ideapad-310-15IKB:~/CLionProjects/lab11/threads-bugs$ ./vector-nolock -t -n 6 -l 100000 -p
        Time: 0.35 seconds
        
        nastya@nastya-Lenovo-ideapad-310-15IKB:~/CLionProjects/lab11/threads-bugs$ ./vector-avoid-hold-and-wait -t -n 6 -l 100000
        Time: 0.71 seconds
        
        nastya@nastya-Lenovo-ideapad-310-15IKB:~/CLionProjects/lab11/threads-bugs$ ./vector-avoid-hold-and-wait -t -n 6 -l 100000 -p
        Time: 0.24 seconds
        
        nastya@nastya-Lenovo-ideapad-310-15IKB:~/CLionProjects/lab11/threads-bugs$ ./vector-try-wait -t -n 6 -l 100000
        Retries: 183178
        Time: 0.69 seconds
        
        nastya@nastya-Lenovo-ideapad-310-15IKB:~/CLionProjects/lab11/threads-bugs$ ./vector-try-wait -t -n 6 -l 100000 -p
        Retries: 0
        Time: 0.13 seconds 
        
       
